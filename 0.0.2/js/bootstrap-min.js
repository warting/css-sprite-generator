"use strict";!function(){function a(e,t){return angular.element((t||r).querySelectorAll(e))}function f(e,t){var n=e.indexOf(t);n>=0&&e.splice(n,1);return t}function l(t){if(t===e)return"global";var n=typeof t;return n!="object"?n:o.call(t).slice(8,-1).toLowerCase()}function c(e){return s.slice.call(e)}function p(e){return{x:e.x,y:e.y,w:e.w,h:e.h}}function d(e,t,n){if(e.lft){var r=d(e.lft,t,n);return r?r:d(e.rgt,t,n)}if(e.used||t>e.w||n>e.h)return!1;if(t==e.w&&n==e.h){e.used=!0;return{x:e.x,y:e.y}}e.lft=p(e);e.rgt=p(e);if(e.w-t>e.h-n){e.lft.w=t;e.rgt.x=e.x+t;e.rgt.w=e.w-t}else{e.lft.h=n;e.rgt.y=e.y+n;e.rgt.h=e.h-n}return d(e.lft,t,n)}var e=window,t=document,n=t.documentElement,r=t.body,i={},s=[],o=i.toString,u=angular.module("wis",["ngRoute"]);n.className="";u.run(["$templateCache",function(e){var t=a("div[ng-view]");e.put(t.attr("ng-view"),t.html());t.attr("ng-view","")}]);if(typeof h=="undefined")var h=function(){};window.packer=h;h.RectanglePacker=function(e,t){this.root={};this.reset(e,t)};h.RectanglePacker.prototype.reset=function(e,t){this.root.x=0;this.root.y=0;this.root.w=e;this.root.h=t;delete this.root.lft;delete this.root.rgt;this.usedWidth=0;this.usedHeight=0};h.RectanglePacker.prototype.getDimensions=function(){return{w:this.usedWidth,h:this.usedHeight}};h.RectanglePacker.prototype.findCoords=function(e,t){var n=d(this.root,e,t);if(n){this.usedWidth<n.x+e&&(this.usedWidth=n.x+e);this.usedHeight<n.y+t&&(this.usedHeight=n.y+t)}return n};(function(e){var t=e.HTMLCanvasElement&&e.HTMLCanvasElement.prototype,n=e.Blob&&function(){try{return Boolean(new Blob)}catch(e){return!1}}(),r=n&&e.Uint8Array&&function(){try{return(new Blob([new Uint8Array(100)])).size===100}catch(e){return!1}}(),i=e.BlobBuilder||e.WebKitBlobBuilder||e.MozBlobBuilder||e.MSBlobBuilder,s=(n||i)&&e.atob&&e.ArrayBuffer&&e.Uint8Array&&function(e){var t,s,o,u,a,f;e.split(",")[0].indexOf("base64")>=0?t=atob(e.split(",")[1]):t=decodeURIComponent(e.split(",")[1]);s=new ArrayBuffer(t.length);o=new Uint8Array(s);for(u=0;u<t.length;u+=1)o[u]=t.charCodeAt(u);a=e.split(",")[0].split(":")[1].split(";")[0];if(n)return new Blob([r?o:s],{type:a});f=new i;f.append(s);return f.getBlob(a)};e.HTMLCanvasElement&&!t.toBlob&&(t.mozGetAsFile?t.toBlob=function(e,n,r){r&&t.toDataURL&&s?e(s(this.toDataURL(n,r))):e(this.mozGetAsFile("blob",n))}:t.toDataURL&&s&&(t.toBlob=function(e,t,n){e(s(this.toDataURL(t,n)))}));t.toBlobSync=function(e,t){return s(this.toDataURL(e,t))};e.dataURLtoBlob=s})(window);u.config(["$httpProvider","$compileProvider","$routeProvider","$locationProvider",function(e,t,n,r){e.interceptors.push("HttpDataURL");t.imgSrcSanitizationWhitelist(/^\s*(blob:|data:image)/);n.when("/",{templateUrl:"/0.0.2/views/index.html"});n.when("/canvas",{templateUrl:"/0.0.2/views/canvas.html",controller:"SpriteCtrl",controllerAs:"Sprite"});n.when("/mycanvas",{templateUrl:"/0.0.2/views/mycanvas.html"});n.when("/download",{templateUrl:"/0.0.2/views/download.html",controller:"DownloadCtrl",controllerAs:"Download"});r.html5Mode(!0)}]);u.controller("MainCtrl",["$q","$filter","$location","$route",function(t,n,r,i){function c(e){var n=t.defer(),r=new Image;r.onload=r.onerror=function(){n.resolve(r.width>0)};r.src="data:image/webp;base64,"+e;return n.promise}var s,o,u=this,a=document.createElement("canvas");a.width=a.height=1;u.arrayRemove=f;u.activeUUID=localStorage.lastUUID;u.activeJson=angular.fromJson(localStorage.getItem(u.activeUUID));u.uuidItems=function(){return Object.keys(localStorage).filter(function(e){return e.match("^css-sprite-generator-")})};u.openUUID=function(e){u.activeUUID=localStorage.lastUUID=e;u.activeJson=angular.fromJson(localStorage.getItem(e));r.path()=="/canvas"?i.reload():r.path("/canvas")};u.newUUID=function(){u.openUUID("css-sprite-generator-"+ +(new Date)+"-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)}))};u.deleteUUID=function(e){localStorage.removeItem(e)};s={js:!0,aDownload:"download"in document.createElement("a"),fileReader:!!e.FileReader,blob:e.Blob&&l(new e.Blob)=="blob",canvas:l(a)=="htmlcanvaselement"&&a.getContext&&!!a.getContext("2d"),localStorage:function(){try{var e=localStorage;e.setItem("mod","mod");e.removeItem("mod");return"storage"==l(e)}catch(t){return!0}}(),todataurlwebpalpha:!1};s.todataurlwebp=s.canvas&&(o=a.toDataURL("image/webp",0)).indexOf("data:image/webp")===0;s.todataurljpeg=s.canvas&&a.toDataURL("image/jpeg",0).indexOf("data:image/jpeg")===0;s.todataurlpng=s.canvas&&a.toDataURL("image/png",0).indexOf("data:image/png")===0;t.all([c("UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA"),c("UklGRhoAAABXRUJQVlA4TA0AAAAvAAAAEAcQERGIiP4HAA=="),c("UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAwAAAARBxAR/Q9ERP8DAABWUDggGAAAABQBAJ0BKgEAAQAAAP4AAA3AAP7mtQAAAA=="),c("UklGRlIAAABXRUJQVlA4WAoAAAASAAAAAAAAAAAAQU5JTQYAAAD/////AABBTk1GJgAAAAAAAAAAAAAAAAAAAGQAAABWUDhMDQAAAC8AAAAQBxAREYiI/gcA"),function(){if(!s.todataurlwebp)return!1;var e=t.defer(),n=new Image,r=a.getContext("2d");n.src=o;n.onload=function(){r.drawImage(n,0,0);s.todataurlwebpalpha=r.getImageData(0,0,1,1).data[3]==0;e.resolve()};n.onerror=e.resolve;return e.promise}()]).then(function(e){var t=4,n=["webpLossy","webpLossless","webpAlpha","webpAnimation"];while(t--)s[n[t]]=e[t];u.supports=s})}]);u.controller("SpriteCtrl",["$q","WebP","$scope","repack",function(e,n,r,i){function u(e){e.preventDefault();e.stopPropagation();var n=a("#excanvas")[0].getBoundingClientRect(),o={};o.height=n.height+"px";o.width=n.width+"px";o.left=n.left+"px";o.bottom=n.bottom+"px";o.right=n.right+"px";o.top=n.top+"px";var u=angular.element("<div id=sdisplay><b></b></div>");u.css(o);a("body",t).css("cursor","nw-resize").append(u).on("mousemove",function(e){e.preventDefault();e.stopPropagation();var t=~~(e.pageX-n.left),r=~~(e.pageY-n.top);u.css({width:t+"px",height:r+"px"}).children("b").text(t+"x"+r)}).one("mouseup",function(e){e.preventDefault();e.stopPropagation();var n=u[0].style;window._canvas.width=parseInt(n.width);window._canvas.height=parseInt(n.height);i(window._canvas,s.json).then(s.calcSize);r.$apply();a("body",t).css("cursor","").off("mousemove");u.remove()})}var s=this,o=angular.fromJson(localStorage.getItem(localStorage.lastUUID));a("#scale").on("mousedown",u);s.setBG=function(){window._canvas.backgroundColor=s.json.datalessJSON.background;s.calcSize()};s.json=o||{imageBackground:"",datalessJSON:{objects:[],background:"rgba(0,0,0,0)"},prefix:"ui-",output:"png",canRepeat:"x",version:2,margin:"",padding:"",uuid:localStorage.lastUUID,retina:!1,width:200,height:200,size:0,quality:1,sameAspect:!1};s.repack=function(){i(window._canvas,s.json).then(s.calcSize)};s.onFileSelect=function(){function c(){var e=t[u],i=new fabric.Sprite({base64:a.result,image:f,name:e.name,origType:e.type,origSize:e.size});e.type==="image/png"&&n.encode(e).then(function(e){i.mimetype="image/webp";i.base64=e.data});l.push(i);r[u].resolve(i);f=new Image;u++;e=t[u];e&&a.readAsDataURL(e)}var t=s.files,r=t.map(e.defer),o=r.map(function(e){return e.promise}),u=0,a=new FileReader,f=new Image,l=[];a.onload=function(){f.src=a.result;f.onload=c};a.readAsDataURL(t[0]);e.all(o).then(function(e){_canvas._objects.push.apply(_canvas._objects,l);for(var t=0,n=l.length;t<n;t++)_canvas._onObjectAdded(l[t]);_canvas.renderOnAddRemove&&_canvas.renderAll();i(window._canvas,s.json).then(s.calcSize)});s.files=[]};s.calcSize=function(){window._canvas.renderAll();var e=window._canvas.toDataURL({format:"png",quality:s.json.quality}),t=dataURLtoBlob(e);s.json.size=t.size;s.json.datalessJSON=window._canvas.toDatalessObject();localStorage.setItem(s.json.uuid,angular.toJson(s.json));r.Main.activeJson=s.json};a("html",t).on("dragenter",function(){a("#app").addClass("hover")}).bind("drop",function(){a("#app").removeClass("hover")})}]);u.controller("DownloadCtrl",["$scope","WebP","$q","$http",function(e,t,n,r){function m(e){return e?"-"+(s.retina?e/2:e)+"px":0}function g(e){var t='[class^="'+e.prefix+'"]{\n	background-image: url('+e.getName()+".png);\n	background-repeat: no-repeat;\n	display: inline-block;\n	text-indent: -99999px;\n	overflow: hidden;\n}\n\n";e.output=="webp/png"&&(t+='\n/* Result pending */\n.js [class^="'+e.prefix+'"]{\n	background-image: none;\n}\n/* No WebP not supported */\n.js.no-webp [class^="'+e.prefix+'"] {\n	background-image: url("'+e.getName()+'.png");\n}\n/* WebP supported */\n.js.webp [class^="'+e.prefix+'"] {\n	background-image: url("'+e.getName()+'.webp");\n}\n');t+="\n\n";if(e.retina){t+='\n@media\n	only screen and (-webkit-min-device-pixel-ratio: 2),\n	only screen and ( min--moz-device-pixel-ratio: 2),\n	only screen and ( -o-min-device-pixel-ratio: 2/1),\n	only screen and ( min-device-pixel-ratio: 2),\n	only screen and ( min-resolution: 192dpi),\n	only screen and ( min-resolution: 2dppx) {\n	[class^="'+e.prefix+'"]{\n		background-image: url(sprite-2x.png);\n		-webkit-background-size: '+s.width/2+"px "+s.height/2+"px;\n		-moz-background-size: "+s.width/2+"px "+s.height/2+"px;\n		background-size: "+s.width/2+"px "+s.height/2+"px;\n	}\n\n	";e.output=="webp/png"&&(t+='\n	/* No JS / WebP not supported */\n	.js.no-webp [class^="'+e.prefix+'"]{\n		background-image: url("'+e.getName()+'-2x.png");\n	}\n	/* WebP supported */\n	.js.webp [class^="'+e.prefix+'"]{\n		background-image: url("'+e.getName()+'-2x.webp");\n	}\n	');t+="\n}\n"}t+="\n\n";var n=e.datalessJSON.objects;if(n){var r,i=-1,o=n.length-1;while(i<o){r=n[i+=1];t+="\n."+e.getClassName(r)+"{ height: "+e.getHeight(r)+"px; width:"+e.getWidth(r)+"px; background-position: "+e.getPos(r)+"; }"}}t+="\n\n.repeat"+e.canRepeat.toUpperCase()+"{\n	";e.canRepeat=="x"?t+="width":t+="height";t+=": 100%;\n	background-repeat: repeat-"+e.canRepeat+";\n}";return t}function y(e){return e.replace(/\/\*(?:(?!\*\/)[\s\S])*\*\/|[\r\n\t]+/g,"").replace(/(\s)*:(\s)*/g,":").replace(/ {2,}/g," ").replace(/ ([{:}]) /g,"$1").replace(/([;,]) /g,"$1").replace(/ !/g,"!")}function b(e){return e.split(",")[1]}function w(){var e=s.getName()+".zip";v(o.generate({type:"blob"}),e)}var i=this,s=e.Main.activeJson,o=new JSZip,u={base64:!0,binary:!0},a=r.get("/demo/demo"),f=n.defer(),l=[a,f],c=!0,h=0,p="/*\n * Css generated by http://cssspritegenerator.net\n */\n",d;a.then(function(e){d=e.data});e.$on("canvasReady",f.resolve);i.set={};s.getClassName=function(e){return c?"x-in"+h++:s.prefix+e.className};s.getName=function(e){return s.name||"sprite"};s.getHeight=function(e){return s.retina?e.origheight/2:e.origheight};s.getWidth=function(e){return s.retina?e.origwidth/2:e.origwidth};s.getPos=function(e){return m(e.left)+" "+m(e.top)};i.update=function(){localStorage.setItem(s.uuid,angular.toJson(s))};i.save=function(){o=new JSZip;var e=s.getName(),r=g(s),a=o.folder(e),f,l,c,h;i.disabled=!0;_canvas._objects.forEach(function(e){var n=e.origType==="image/png"&&e.base64.split(";")[0]==="data:image/webp"?t.decode64(e.base64).toDataURL("image/png",1):e.base64;a.file("original files/"+e.name,b(n),u)});a.file(e+".css",p+r);a.file(e+".min.css",p+y(r));a.file(e+".html",d.replace("___SPRITENAME___",e).replace("___SPRITE___",localStorage[s.uuid]));f=b(_canvas.toDataURL({quality:s.quality}));c=document.createElement("canvas");c.width=s.width/2;c.height=s.height/2;c.getContext("2d").drawImage(_canvas.lowerCanvasEl,0,0,c.width,c.height);l=b(c.toDataURL("",s.quality));if(/webp/.test(s.output)){if(s.output=="webp/png")if(s.retina){a.file(e+".png",l,u);a.file(e+"-2x.png",f,u)}else a.file(e+".png",f,u);s.retina?n.all([t.encode64(f),t.encode64(l)]).then(function(t){f=b(t[0].data);l=b(t[1].data);a.file(e+".webp",l,u);a.file(e+"-2x.webp",f,u);w()}):t.encode64(f).then(function(t){a.file(e+".webp",b(t.data),u);w()})}else{if(s.retina){a.file(e+".png",l,u);a.file(e+"-2x.png",f,u)}else a.file(e+".png",f,u);w()}};f.promise.then(function(){s.datalessJSON.objects=_canvas._objects;var e=URL.createObjectURL(dataURLtoBlob(_canvas.toDataURL())),t=s.prefix,n=s.output,r=s.name;s.prefix="x-in";s.output="png";s.name="____sprite____";i.css=g(s).replace("____sprite____.png",e);s.prefix=t;s.output=n;s.name=r;c=!1})}]);u.directive("wisScroll",function(){return{link:function(t,i){var s=250,o=function(e,t,n,r){e/=r/2;if(1>e)return n/2*e*e+t;e--;return-n/2*(e*(e-2)-1)+t};i.on("click",function(t){t.preventDefault();var i=r.scrollTop,u=(e.innerHeight||n.clientHeight||r.clientHeight)+45-i,a=0,f=function(){a+=20;var e=o(a,i,u,s);r.scrollTop=e;a<s&&setTimeout(f,20)};f()})}}});u.directive("wisColorValidate",function(){return{require:"ngModel",link:function(e,t,n,r){function s(e){if(e==="")return!0;i.fillStyle="#000000";i.fillStyle=e;if(i.fillStyle!=="#000000")return!0;i.fillStyle="#ffffff";i.fillStyle=e;return i.fillStyle!=="#ffffff"}var i=document.createElement("canvas").getContext("2d");r.$parsers.unshift(function(e){var t=s(e);r.$setValidity("color",t);return t?e:undefined});r.$formatters.unshift(function(e){r.$setValidity("color",s(e));return e})}}});u.directive("wisFile",["$sniffer","$parse",function(e,t){function n(e,t){return e.toLocaleLowerCase().endsWith(t)}function r(e,t){e=e.split("/");t=t.split("/");return e[0]===t[0]&&(t[1]==="*"||t[1]===e[1])}function i(e){e.stopPropagation();e.preventDefault()}function s(e,t,i,s){var o=[],u="directory"in i||"multiple"in i,a=!0,f,l,h,p=t.length;if(i.accept){h=i.accept.split(",");while(a&&p--){f=h.length;a=!1;while(!a&&f--){l=h[f].trim();a=l[0]=="."?n(t[p].name,l):r(t[p].type,l)}}}s.$setValidity("file",a);a?o=u?c(t):t[0]:u&&(o=[]);s.$setViewValue(o)}return{restrict:"A",require:"?ngModel",link:function(n,r,o,u){var a=e&&e.vendorPrefix.toLocaleLowerCase()+"directory",f=l(r[0])=="htmlinputelement"&&o.type=="file";if(!u)return;if(f&&"directory"in o&&!o.directory&&a in r[0]){var c=t(o.supported);c.assign(n,a in r[0]);r[0][a]=!0}u.$render=function(){};r.bind("dragover dragenter",i);r.bind("drop change",function(e){e=e.originalEvent||e;var t=(e.dataTransfer||e.target).files;e.preventDefault();n.$apply(function(){s(n,t,o,u)})})}}}]);u.directive("wisSprite",["$q","WebP",function(t,n){var r;fabric.Sprite=fabric.util.createClass(fabric.Rect,{type:"sprite",initialize:function(e){var t=e.image;e=e||{};this.origwidth=this.width=t.width;this.origheight=this.height=t.height;this.pad="";this.mar="";this.hasControls=!1;this.borderColor="red";this.lockMovementX=!0;this.lockMovementY=!0;this.repeat=!1;e.className=e.className||e.name.replace(/\.[^/.]+$/g,"").replace(/(\S)(\S*)/g,function r(e,t,n){r.i=-~r.i;return t[r.i===1?"toLowerCase":"toUpperCase"]()+n.toLowerCase()}).replace(/\s|\./g,"").replace(/[^a-z0-9]/g,function(e){var t=e.charCodeAt(0);return t===32?"-":t===95||t===45?e:("000"+t.toString(16)).slice(-4)});var n=new fabric.Pattern({source:t,repeat:"repeat"});this.fill=n;this.callSuper("initialize",e)},toObject:function(){return{base64:this.base64,className:this.className,mimetype:this.mimetype,left:this.left,mar:this.mar,name:this.name,origSize:this.origSize,type:"sprite",top:this.top,origType:this.origType,pad:this.pad,repeat:this.repeat}},render:function(e){this.width=this.repeat&&r.canRepeat==="x"?e.canvas.width:this.origwidth;this.height=this.repeat&&r.canRepeat==="y"?e.canvas.height:this.origheight;var t=this.pad||r.padding||[0,0,0,0],n=[this.left-t[3],this.top-t[0],this.width+t[3]+t[1],this.height+t[0]+t[2]],i=e.fillStyle;e.clearRect(n[0],n[1],n[2],n[3]);e.fillStyle=r.imageBackground;e.fillStyle=this.background;e.fillRect(n[0],n[1],n[2],n[3]);e.fillStyle=i;this.callSuper("render",e)},_render:function(e){this.callSuper("_render",e)}});fabric.Sprite.fromObject=function(e){return new fabric.Sprite(e)};return{restrict:"A",scope:{uuid:"&wisSprite",object:"&object",sprite:"&sprite"},link:function(i,s){var o=i.uuid(),u=e._canvas=new fabric.Canvas(s[0],{selection:!1,includeDefaultValues:!1,hoverCursor:"pointer",selectionColor:"rgba(255, 255, 255, 0.3)"}),f=i.sprite()||angular.fromJson(localStorage.getItem(o));u.selectionLineWidth=3;u.selectionBorderColor="red";u.setWidth(f.width);u.setHeight(f.height);u.on("object:selected",function(e){i.$parent.Sprite.object=e.target;e.target.bringToFront();i.$apply();a("#thumbnail").html("").append(e.target.fill.source)});console.log("start");console.time("foo1");console.time("foo2");t.all(f.datalessJSON.objects.map(function(e){var r=t.defer();if(!i.$parent.Main.supports.webpAlpha&&e.base64.split(";")[0]=="data:image/webp"){e.image=n.decode64(e.base64);return}var s=new Image;s.src=e.base64;s.onload=function(){e.image=s;r.resolve()};return r.promise})).then(function(){console.timeEnd("foo1");i.$emit("canvasReady");r=f;u.loadFromJSON(r.datalessJSON);u.renderAll();console.timeEnd("foo2")})}}}]);u.factory("repack",["$filter","$q",function(t,n){function r(t,n,r,i,s){var o,u=!0,a=t.length,f,l,c,h,p;while(u){u=!1;n<r?n+=1:r+=1;o=new e.packer.RectanglePacker(n,r);for(f=0;f<a;f++){p=t[f];l=p.width;c=p.height;p.repeat&&i==="x"&&(l=p.width>n?p.width:n);p.repeat&&i==="y"&&(c=p.height>r?p.height:r);h=o.findCoords(l,c);if(h){p.x=h.x;p.y=h.y}else u=!0}}var d=o.getDimensions();n=d.w;r=d.h;s({points:t.map(function(e){return{left:e.x,top:e.y}}),dimensions:{width:n,height:r}})}function i(e,i){function o(e){var t=e.pad||i.padding||[0,0,0,0],n=e.mar||i.margin||[0,0,0,0];return{width:e.origwidth+n[1]+n[3]+t[1]+t[3],height:e.origheight+n[0]+n[2]+t[0]+t[2],repeat:e.repeat}}var s=n.defer(),u=e.getObjects();if(!u.length){e.setDimensions({width:200,height:200});s.resolve();angular.extend(i,{width:200,height:200});return s.promise}var a=t("orderBy")(u,["repeat",function(e){var t=o(e);return t.width*t.height}],!0),f=a.map(o);r(f,e.width,e.height,i.canRepeat,function(t){e.setDimensions(t.dimensions);t.points.forEach(function(e,t){var n=u[u.indexOf(a[t])],r=n.pad||i.padding||[0,0,0,0],s=n.mar||i.margin||[0,0,0,0];n.set(e);n.left=e.left+s[3]+r[3];n.top=e.top+s[0]+r[0]});setTimeout(function(){e.setDimensions(t.dimensions);var n=e._objects,r=n.length;while(r--)n[r].setCoords();s.resolve()},0);angular.extend(i,t.dimensions);e.renderAll()});return s.promise}return i}]);u.directive("wisPadding",function(){return{require:"ngModel",link:function(e,t,n,r){var i=" ",s=function(e){return e?Array(5).join(e+" ").split(" ").slice(0,4).map(function(e){return+e}):""};r.$parsers.push(s);r.$formatters.push(function(e){return Array.isArray(e)&&!angular.equals([0,0,0,0],e)?e.join(" "):undefined});r.$isEmpty=function(e){return!e||!e.length}}}});u.directive("wisClassname",function(){return{restrict:"A",require:"ngModel",scope:{set:"=wisClassname"},link:function(e,t,n,r){function i(e){r.$setValidity("space",e.indexOf(" ")==-1);return e}function a(e){if(e!==o){o&&(s[o]=(s[o]||1)-1);if(e){s[e]=(s[e]||0)+u;u=1}}return e}function f(e){o=e;return e}r.$parsers.unshift(function(e){i(e);return e});r.$formatters.unshift(function(e){i(e);return e});var s=e.set,o,u=.5;r.$formatters.push(a);r.$parsers.push(a);r.$formatters.unshift(f);r.$parsers.push(f);e.$watch(function(){return s[r.$viewValue]<=1},function(e){r.$setValidity("unique",e)})}}});u.filter("filesize",function(){return function(e){return e>1073741824?Math.round(e/1073741824,1)+" GB":e>1048576?Math.round(e/1048576,1)+" MB":e>1024?Math.round(e/1024,1)+" KB":e+" b"}});u.factory("HttpDataURL",["$q",function(e){function t(e){var t="",n=new Uint8Array(e),r=n.byteLength,i=0;for(;i<r;i++)t+=String.fromCharCode(n[i]);return"data:image/webp;base64,"+btoa(t)}return{request:function(n){if(n.responseType=="dataURL"){n.responseType="arraybuffer";n.transformResponse=[t]}return n||e.when(n)}}}]);u.factory("WebP",["$http","$q",function(e,t){var n=[],r=function(){var t=n[0];e.post("https://warting-webp.p.mashape.com/",t.data,{headers:{"X-Mashape-Authorization":"6fenynov1gvx968gscs0ptjx3pmbpi","Content-Type":undefined},responseType:"dataURL",transformRequest:angular.identity}).then(function(e){n.shift();t.defer.resolve(e);n.length>0&&r()},function(e){t.defer.reject(e)})},i={encode64:function(e){return i.encode(window.dataURLtoBlob("data:image/png;base64,"+e))},encode:function(e){var i=new FormData,s={headers:{"X-Mashape-Authorization":"6fenynov1gvx968gscs0ptjx3pmbpi","Content-Type":undefined},responseType:"dataURL",transformRequest:angular.identity};i.append("file",e);i.append("quality","100");var o=t.defer();n.push({data:i,defer:o});n.length===1&&r();return o.promise},decode64:function(e){return i.decodeBinary(atob(e.split(",")[1]))},decodeBinary:function(e){var t={width:{value:0},height:{value:0}},n=new WebPDecoder,r=new Array(e.length),i=e.length;while(i--)r[i]=e.charCodeAt(i);var s=n.WebPDecoderConfig,o=s.j,u=s.input;o.J=4;n.WebPDecode(r,r.length,s);var a=o.c.RGBA.ma;if(a){var f=o.height,l=o.width,c=document.createElement("canvas");c.height=f;c.width=l;var h=c.getContext("2d"),p=h.createImageData(c.width,c.height),d=p.data;for(var v=0;v<f;v++)for(var m=0;m<l;m++){d[0+m*4+l*4*v]=a[1+m*4+l*4*v];d[1+m*4+l*4*v]=a[2+m*4+l*4*v];d[2+m*4+l*4*v]=a[3+m*4+l*4*v];d[3+m*4+l*4*v]=a[0+m*4+l*4*v]}h.putImageData(p,0,0);return c}},decodeBlob:function(e){}};return i}]);var v=v||typeof navigator!="undefined"&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(e){var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=e.URL||e.webkitURL||e,i=t.createElementNS("http://www.w3.org/1999/xhtml","a"),s=!e.externalHost&&"download"in i,o=function(n){var r=t.createEvent("MouseEvents");r.initMouseEvent("click",!0,!1,e,0,0,0,0,0,!1,!1,!1,!1,0,null);n.dispatchEvent(r)},u=e.webkitRequestFileSystem,a=e.requestFileSystem||u||e.mozRequestFileSystem,f=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},l="application/octet-stream",c=0,h=[],p=function(){var e=h.length;while(e--){var t=h[e];typeof t=="string"?r.revokeObjectURL(t):t.remove()}h.length=0},d=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var i=e["on"+t[r]];if(typeof i=="function")try{i.call(e,n||e)}catch(s){f(s)}}},v=function(r,o){var f=this,p=r.type,v=!1,m,g,y=function(){var e=n().createObjectURL(r);h.push(e);return e},b=function(){d(f,"writestart progress write writeend".split(" "))},w=function(){if(v||!m)m=y(r);g?g.location.href=m:window.open(m,"_blank");f.readyState=f.DONE;b()},E=function(e){return function(){if(f.readyState!==f.DONE)return e.apply(this,arguments)}},S={create:!0,exclusive:!1},x;f.readyState=f.INIT;o||(o="download");if(s){m=y(r);t=e.document;i=t.createElementNS("http://www.w3.org/1999/xhtml","a");i.href=m;i.download=o;var T=t.createEvent("MouseEvents");T.initMouseEvent("click",!0,!1,e,0,0,0,0,0,!1,!1,!1,!1,0,null);i.dispatchEvent(T);f.readyState=f.DONE;b();return}if(e.chrome&&p&&p!==l){x=r.slice||r.webkitSlice;r=x.call(r,0,r.size,l);v=!0}u&&o!=="download"&&(o+=".download");if(p===l||u)g=e;if(!a){w();return}c+=r.size;a(e.TEMPORARY,c,E(function(e){e.root.getDirectory("saved",S,E(function(e){var t=function(){e.getFile(o,S,E(function(e){e.createWriter(E(function(t){t.onwriteend=function(t){g.location.href=e.toURL();h.push(e);f.readyState=f.DONE;d(f,"writeend",t)};t.onerror=function(){var e=t.error;e.code!==e.ABORT_ERR&&w()};"writestart progress write abort".split(" ").forEach(function(e){t["on"+e]=f["on"+e]});t.write(r);f.abort=function(){t.abort();f.readyState=f.DONE};f.readyState=f.WRITING}),w)}),w)};e.getFile(o,{create:!1},E(function(e){e.remove();t()}),E(function(e){e.code===e.NOT_FOUND_ERR?t():w()}))}),w)}),w)},m=v.prototype,g=function(e,t){return new v(e,t)};m.abort=function(){var e=this;e.readyState=e.DONE;d(e,"abort")};m.readyState=m.INIT=0;m.WRITING=1;m.DONE=2;m.error=m.onwritestart=m.onprogress=m.onwrite=m.onabort=m.onerror=m.onwriteend=null;e.addEventListener("unload",p,!1);return g}(typeof self!="undefined"&&self||typeof window!="undefined"&&window||this.content);typeof module!="undefined"&&(module.exports=v)}();